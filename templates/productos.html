{% extends "base.html" %}

{% block title %}Productos - Sistema de Gestión Mis Angeles{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="bi bi-box"></i> Gestión de Productos
            </h2>
            <a href="{{ url_for('nuevo_producto') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Nuevo Producto
            </a>
        </div>
    </div>
</div>

<!-- Filtros y búsqueda -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label for="searchInput" class="form-label">
                            <i class="bi bi-search"></i> Buscar Producto
                        </label>
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="Código, nombre o descripción...">
                    </div>
                    <div class="col-md-3">
                        <label for="categoryFilter" class="form-label">
                            <i class="bi bi-tags"></i> Categoría
                        </label>
                        <select class="form-select" id="categoryFilter">
                            <option value="">Todas las categorías</option>
                            <option value="Proteínas">Proteínas</option>
                            <option value="Granos">Granos</option>
                            <option value="Aceites">Aceites</option>
                            <option value="Lácteos">Lácteos</option>
                            <option value="Frutas">Frutas</option>
                            <option value="Verduras">Verduras</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="stockFilter" class="form-label">
                            <i class="bi bi-clipboard-data"></i> Stock
                        </label>
                        <select class="form-select" id="stockFilter">
                            <option value="">Todos</option>
                            <option value="con_stock">Con Stock</option>
                            <option value="sin_stock">Sin Stock</option>
                            <option value="bajo_stock">Stock Bajo</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-arrow-clockwise"></i> Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lista de productos -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul"></i> Lista de Productos 
                    <span class="badge bg-primary" id="productCount">{{ productos|length }}</span>
                </h5>
            </div>
            <div class="card-body">
                {% if productos %}
                <div class="table-responsive">
                    <table class="table table-hover" id="productTable">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Producto</th>
                                <th>Categoría</th>
                                <th>Precio Detal USD</th>
                                <th>Precio Mayor USD</th>
                                <th>Equivalencia</th>
                                <th>Stock</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for producto in productos %}
                            <tr class="product-row" 
                                data-codigo="{{ producto.codigo|lower }}"
                                data-nombre="{{ producto.nombre|lower }}"
                                data-descripcion="{{ producto.descripcion|lower if producto.descripcion else '' }}"
                                data-categoria="{{ producto.categoria|lower if producto.categoria else '' }}">
                                <td>
                                    <span class="badge bg-primary">{{ producto.codigo }}</span>
                                </td>
                                <td>
                                    <strong>{{ producto.nombre }}</strong>
                                    {% if producto.descripcion %}
                                    <br>
                                    <small class="text-muted">{{ producto.descripcion }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if producto.categoria %}
                                        <span class="badge bg-info">{{ producto.categoria }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Sin categoría</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>${{ "%.2f"|format(producto.precio_detal_usd) }}</strong>
                                </td>
                                <td>
                                    <strong>${{ "%.2f"|format(producto.precio_mayor_usd) }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-warning">{{ producto.equivalencia }} u.</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('nueva_entrada') }}?producto={{ producto.codigo }}" 
                                           class="btn btn-outline-success" title="Agregar Stock">
                                            <i class="bi bi-plus-circle"></i>
                                        </a>
                                        <a href="{{ url_for('nueva_venta') }}?producto={{ producto.codigo }}" 
                                           class="btn btn-outline-warning" title="Vender">
                                            <i class="bi bi-arrow-up-circle"></i>
                                        </a>
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" 
                                                onclick="editProduct('{{ producto.codigo }}')" 
                                                title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" 
                                                onclick="deleteProduct('{{ producto.codigo }}', '{{ producto.nombre }}')" 
                                                title="Eliminar">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <h5 class="text-muted mt-3">No hay productos registrados</h5>
                    <p class="text-muted">Comienza agregando tu primer producto al sistema.</p>
                    <a href="{{ url_for('nuevo_producto') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Agregar Primer Producto
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar producto -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil"></i> Editar Producto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editCodigo" class="form-label">Código</label>
                            <input type="text" class="form-control" id="editCodigo" name="codigo" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editNombre" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="editNombre" name="nombre" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editCategoria" class="form-label">Categoría</label>
                            <select class="form-select" id="editCategoria" name="categoria">
                                <option value="">Seleccionar categoría</option>
                                <option value="Proteínas">Proteínas</option>
                                <option value="Granos">Granos</option>
                                <option value="Aceites">Aceites</option>
                                <option value="Lácteos">Lácteos</option>
                                <option value="Frutas">Frutas</option>
                                <option value="Verduras">Verduras</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editEquivalencia" class="form-label">Equivalencia (unidades)</label>
                            <input type="number" class="form-control" id="editEquivalencia" name="equivalencia" 
                                   min="1" value="1" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editPrecioDetal" class="form-label">Precio Detal USD</label>
                            <input type="number" class="form-control" id="editPrecioDetal" name="precio_detal_usd" 
                                   step="0.01" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editPrecioMayor" class="form-label">Precio Mayor USD</label>
                            <input type="number" class="form-control" id="editPrecioMayor" name="precio_mayor_usd" 
                                   step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editDescripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" id="editDescripcion" name="descripcion" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">
                    <i class="bi bi-check-circle"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentProduct = null;
    
    // Búsqueda y filtros
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const stockFilter = document.getElementById('stockFilter');
        
        // Función de búsqueda
        function filterProducts() {
            const searchTerm = searchInput.value.toLowerCase();
            const categoryTerm = categoryFilter.value.toLowerCase();
            const stockTerm = stockFilter.value;
            
            const rows = document.querySelectorAll('.product-row');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const codigo = row.dataset.codigo;
                const nombre = row.dataset.nombre;
                const descripcion = row.dataset.descripcion;
                const categoria = row.dataset.categoria;
                
                let showRow = true;
                
                // Filtro de búsqueda
                if (searchTerm) {
                    showRow = codigo.includes(searchTerm) || 
                             nombre.includes(searchTerm) || 
                             descripcion.includes(searchTerm);
                }
                
                // Filtro de categoría
                if (categoryTerm && showRow) {
                    showRow = categoria.includes(categoryTerm);
                }
                
                // Filtro de stock (por ahora solo muestra todos)
                if (stockTerm && showRow) {
                    // Implementar lógica de stock cuando tengamos datos de inventario
                }
                
                row.style.display = showRow ? '' : 'none';
                if (showRow) visibleCount++;
            });
            
            document.getElementById('productCount').textContent = visibleCount;
        }
        
        // Eventos de filtrado
        searchInput.addEventListener('input', filterProducts);
        categoryFilter.addEventListener('change', filterProducts);
        stockFilter.addEventListener('change', filterProducts);
    });
    
    // Limpiar filtros
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('stockFilter').value = '';
        
        const rows = document.querySelectorAll('.product-row');
        rows.forEach(row => row.style.display = '');
        document.getElementById('productCount').textContent = rows.length;
    }
    
    // Editar producto
    function editProduct(codigo) {
        // Por ahora, redirigir a una página de edición
        // En una implementación completa, cargaríamos los datos en el modal
        alert('Función de edición en desarrollo. Por ahora, usa la funcionalidad de agregar nuevo producto.');
    }
    
    // Eliminar producto
    function deleteProduct(codigo, nombre) {
        if (confirm(`¿Estás seguro de que quieres eliminar el producto "${nombre}" (${codigo})?\n\nEsta acción no se puede deshacer.`)) {
            // Por ahora, mostrar mensaje
            alert('Función de eliminación en desarrollo. Por ahora, usa la funcionalidad de edición.');
        }
    }
    
    // Guardar producto (para el modal)
    function saveProduct() {
        if (currentProduct) {
            // Implementar guardado
            alert('Función de guardado en desarrollo.');
        }
    }
    
    // Formatear precios automáticamente
    document.addEventListener('DOMContentLoaded', function() {
        const priceInputs = document.querySelectorAll('input[type="number"]');
        priceInputs.forEach(input => {
            if (input.name.includes('precio')) {
                input.addEventListener('blur', function() {
                    const value = parseFloat(this.value);
                    if (!isNaN(value)) {
                        this.value = value.toFixed(2);
                    }
                });
            }
        });
    });
</script>
{% endblock %}
